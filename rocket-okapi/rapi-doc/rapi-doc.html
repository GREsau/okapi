<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Rapi Docs</title>
  <script type="module" src="https://unpkg.com/rapidoc/dist/rapidoc-min.js"></script>
  <script>
    /**
    * Slug a string to create something we can use in the url
    */
    const slug = (s) => s
      .replace(/ /g, '-')
      .toLowerCase();

    const routes = [ROUTES];  // right routes are inserted from Rust

    /**
    * Finds the base url on which the documentation is served.
    */
    const findBaseUrl = () => {
      const url = window.location.pathname;
      const segments = url.split('/');
      const lastSegment = segments[segments.length - 1]
      if (routes.some(([url, spec]) => slug(spec) === lastSegment)) {
        // if the last piece of the segments is one of the api definitions, it should not be
        // included in the base url.
        segments.pop();
      }
      return segments.join('/');
    };

    const baseUrl = findBaseUrl();

    /**
    * Obtains the currently selected spec, as defined by the url
    */
    const getCurSpec = () => {
      const url = window.location.pathname;
      return url.substring(baseUrl.length + 1);
    };

    const updateSpec = (resource) => {
      const rapi = document.getElementById('rapi');
      rapi.loadSpec(resource);
    };

    /**
    * Called when the selected value in the select changes. Updates the displayed
    * documentation, and then updates the url for deep linking purposes.
    */
    const setUrl = () => {
      // first query the needed info from the select
      const select = document.getElementById('select');
      const resource = select.options[select.selectedIndex].value;
      const resourceName = select.options[select.selectedIndex].text;

      updateSpec(resource);

      // update the history for deeplinking
      window.history.pushState({}, '', `${baseUrl}/${slug(resourceName)}`);
    };

    window.onload = () => {
      const select = document.getElementById('select');
      // add all possible options to the select on page load
      for (const [url, name] of routes) {
        const option = document.createElement('option');
        option.text = name;
        option.value = url;
        select.add(option);
      }
      // if there is a currently selected spec, find out which one it is and display that definition
      const spec = getCurSpec();
      if (spec) {
        const idx = routes.findIndex(([url, name]) => spec === slug(name));
        select.value = routes[idx][0];
        updateSpec(routes[idx][0]);
      }
    };
  </script>
</head>
<body>
  <div id="docs">
    <rapi-doc 
      id="rapi"
      spec-url="SPEC_URL"
      sort-tags="SORT_TAGS"
      sort-endpoints-by="SORT_ENDPOINTS_BY"
      heading-text="HEADING_TEXT"
      goto-path="GOTO_PATH"
      theme="THEME"
      bg-color="BG_COLOR"
      text-color="TEXT_COLOR"
      header-color="HEADER_COLOR"
      primary-color="PRIMARY_COLOR"
      regular-font="REGULAR_FONT"
      mono-font="MONO_FONT"
      font-size="FONT_SIZE"
      nav-bg-color="NAV_BG_COLOR"
      nav-bg-image="NAV_BG_IMAGE"
      nav-bg-image-repeat="NAV_BG_IMAGE_REPEAT"
      nav-text-color="NAV_TEXT_COLOR"
      nav-hover-bg-color="NAV_HOVER_BG_COLOR"
      nav-hover-text-color="NAV_HOVER_TEXT_COLOR"
      nav-accent-color="NAV_ACCENT_COLOR"
      nav-item-spacing="NAV_ITEM_SPACING"
      layout="LAYOUT"
      render-style="RENDER_STYLE"
      schema-style="SCHEMA_STYLE"
      schema-expand-level="SCHEMA_EXPAND_LEVEL"
      schema-description-expanded="SCHEMA_DESCRIPTION_EXPANDED"
      default-schema-tab="DEFAULT_SCHEMA_TAB"
      response-area-height="RESPONSE_AREA_HEIGHT"
      show-info="SHOW_INFO"
      info-description-headings-in-navbar="INFO_DESCRIPTIONS_IN_NAVBAR"
      show-components="SHOW_COMPONENTS"
      show-header="SHOW_HEADER"
      allow-authentication="ALLOW_AUTHENTICATION"
      allow-spec-url-load="ALLOW_SPEC_URL_LOAD"
      allow-spec-file-load="ALLOW_SPEC_FILE_LOAD"
      allow-search="ALLOW_SEARCH"
      allow-try="ALLOW_TRY"
      allow-server-selection="ALLOW_SERVER_SELECTION"
      api-key-name="API_KEY_NAME"
      api-key-value="API_KEY_VALUE"
      api-key-location="API_KEY_LOCATION"
      server-url="SERVER_URL"
      default-api-server="DEFAULT_API_SERVER"
    >
      <select id="select" onchange="setUrl()"></select>
      <LOGO/>
      <FOOTER/>
      <NAV_LOGO/>
    </rapi-doc>
  </div>
</body>
</html>
